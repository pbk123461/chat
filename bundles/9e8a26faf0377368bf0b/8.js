(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{936:function(e,a,t){"use strict";t.r(a),t.d(a,"default",(function(){return f}));var s=t(13),r=t.n(s),n=t(120),i=t.n(n),c=t(406),o=t.n(c),l=t(1),h=t(122),u=t(121),p=t(254),m=t(123),y=t(227),b=t(352),d=t(134),k=t(136),P=t(147),C=function(e){return e.Passphrase="passphrase",e.PassphraseConfirm="passphrase_confirm",e.ShowKey="show_key",e.KeepItSafe="keep_it_safe",e.BackingUp="backing_up",e.Done="done",e.OptOutConfirm="opt_out_confirm",e}(C||{});class f extends i.a.PureComponent{constructor(e){super(e),r()(this,"keyBackupInfo",void 0),r()(this,"recoveryKeyNode",Object(n.createRef)()),r()(this,"passphraseField",Object(n.createRef)()),r()(this,"onCopyClick",(()=>{Object(y.a)(this.recoveryKeyNode.current)&&this.setState({copied:!0,phase:C.KeepItSafe})})),r()(this,"onDownloadClick",(()=>{const e=new Blob([this.keyBackupInfo.recovery_key],{type:"text/plain;charset=us-ascii"});o.a.saveAs(e,"security-key.txt"),this.setState({downloaded:!0,phase:C.KeepItSafe})})),r()(this,"createBackup",(async()=>{const{secureSecretStorage:e}=this.state;let a;this.setState({phase:C.BackingUp,error:void 0});try{e?await Object(p.b)((async()=>{a=await h.a.get().prepareKeyBackupVersion(null,{secureSecretStorage:!0}),a=await h.a.get().createKeyBackupVersion(a)})):a=await h.a.get().createKeyBackupVersion(this.keyBackupInfo),await h.a.get().scheduleAllGroupSessionsForBackup(),this.setState({phase:C.Done})}catch(e){l.a.error("Error creating key backup",e),a&&h.a.get().deleteKeyBackupVersion(a.version),this.setState({error:e})}})),r()(this,"onCancel",(()=>{this.props.onFinished(!1)})),r()(this,"onDone",(()=>{this.props.onFinished(!0)})),r()(this,"onSetUpClick",(()=>{this.setState({phase:C.Passphrase})})),r()(this,"onSkipPassPhraseClick",(async()=>{this.keyBackupInfo=await h.a.get().prepareKeyBackupVersion(),this.setState({copied:!1,downloaded:!1,phase:C.ShowKey})})),r()(this,"onPassPhraseNextClick",(async e=>{if(e.preventDefault(),this.passphraseField.current){if(await this.passphraseField.current.validate({allowEmpty:!1}),!this.passphraseField.current.state.valid)return this.passphraseField.current.focus(),void this.passphraseField.current.validate({allowEmpty:!1,focused:!0});this.setState({phase:C.PassphraseConfirm})}})),r()(this,"onPassPhraseConfirmNextClick",(async e=>{e.preventDefault(),this.state.passPhrase===this.state.passPhraseConfirm&&(this.keyBackupInfo=await h.a.get().prepareKeyBackupVersion(this.state.passPhrase),this.setState({copied:!1,downloaded:!1,phase:C.ShowKey}))})),r()(this,"onSetAgainClick",(()=>{this.setState({passPhrase:"",passPhraseValid:!1,passPhraseConfirm:"",phase:C.Passphrase})})),r()(this,"onKeepItSafeBackClick",(()=>{this.setState({phase:C.ShowKey})})),r()(this,"onPassPhraseValidate",(e=>{this.setState({passPhraseValid:!!e.valid})})),r()(this,"onPassPhraseChange",(e=>{this.setState({passPhrase:e.target.value})})),r()(this,"onPassPhraseConfirmChange",(e=>{this.setState({passPhraseConfirm:e.target.value})})),this.state={secureSecretStorage:null,phase:C.Passphrase,passPhrase:"",passPhraseValid:!1,passPhraseConfirm:"",copied:!1,downloaded:!1}}async componentDidMount(){const e=h.a.get(),a=await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing");this.setState({secureSecretStorage:a}),a&&(this.setState({phase:C.BackingUp}),this.createBackup())}renderPhasePassPhrase(){return i.a.createElement("form",{onSubmit:this.onPassPhraseNextClick},i.a.createElement("p",null,Object(u.b)("<b>Warning</b>: you should only set up key backup from a trusted computer.",{},{b:e=>i.a.createElement("b",null,e)})),i.a.createElement("p",null,Object(u.b)("We'll store an encrypted copy of your keys on our server. Secure your backup with a Security Phrase.")),i.a.createElement("p",null,Object(u.b)("For maximum security, this should be different from your account password.")),i.a.createElement("div",{className:"mx_CreateKeyBackupDialog_primaryContainer"},i.a.createElement("div",{className:"mx_CreateKeyBackupDialog_passPhraseContainer"},i.a.createElement(b.a,{className:"mx_CreateKeyBackupDialog_passPhraseInput",onChange:this.onPassPhraseChange,minScore:4,value:this.state.passPhrase,onValidate:this.onPassPhraseValidate,fieldRef:this.passphraseField,autoFocus:!0,label:Object(u.d)("Enter a Security Phrase"),labelEnterPassword:Object(u.d)("Enter a Security Phrase"),labelStrongPassword:Object(u.d)("Great! This Security Phrase looks strong enough."),labelAllowedButUnsafe:Object(u.d)("Great! This Security Phrase looks strong enough.")}))),i.a.createElement(P.a,{primaryButton:Object(u.b)("Next"),onPrimaryButtonClick:this.onPassPhraseNextClick,hasCancel:!1,disabled:!this.state.passPhraseValid}),i.a.createElement("details",null,i.a.createElement("summary",null,Object(u.b)("Advanced")),i.a.createElement(m.a,{kind:"primary",onClick:this.onSkipPassPhraseClick},Object(u.b)("Set up with a Security Key"))))}renderPhasePassPhraseConfirm(){let e,a,t;return this.state.passPhraseConfirm===this.state.passPhrase?(e=Object(u.b)("That matches!"),a=Object(u.b)("Use a different passphrase?")):this.state.passPhrase.startsWith(this.state.passPhraseConfirm)||(e=Object(u.b)("That doesn't match."),a=Object(u.b)("Go back to set it again.")),e&&(t=i.a.createElement("div",{className:"mx_CreateKeyBackupDialog_passPhraseMatch"},i.a.createElement("div",null,e),i.a.createElement(m.a,{kind:"link",onClick:this.onSetAgainClick},a))),i.a.createElement("form",{onSubmit:this.onPassPhraseConfirmNextClick},i.a.createElement("p",null,Object(u.b)("Enter your Security Phrase a second time to confirm it.")),i.a.createElement("div",{className:"mx_CreateKeyBackupDialog_primaryContainer"},i.a.createElement("div",{className:"mx_CreateKeyBackupDialog_passPhraseContainer"},i.a.createElement("div",null,i.a.createElement("input",{type:"password",onChange:this.onPassPhraseConfirmChange,value:this.state.passPhraseConfirm,className:"mx_CreateKeyBackupDialog_passPhraseInput",placeholder:Object(u.b)("Repeat your Security Phrase…"),autoFocus:!0})),t)),i.a.createElement(P.a,{primaryButton:Object(u.b)("Next"),onPrimaryButtonClick:this.onPassPhraseConfirmNextClick,hasCancel:!1,disabled:this.state.passPhrase!==this.state.passPhraseConfirm}))}renderPhaseShowKey(){return i.a.createElement("div",null,i.a.createElement("p",null,Object(u.b)("Your Security Key is a safety net - you can use it to restore access to your encrypted messages if you forget your Security Phrase.")),i.a.createElement("p",null,Object(u.b)("Keep a copy of it somewhere secure, like a password manager or even a safe.")),i.a.createElement("div",{className:"mx_CreateKeyBackupDialog_primaryContainer"},i.a.createElement("div",{className:"mx_CreateKeyBackupDialog_recoveryKeyHeader"},Object(u.b)("Your Security Key")),i.a.createElement("div",{className:"mx_CreateKeyBackupDialog_recoveryKeyContainer"},i.a.createElement("div",{className:"mx_CreateKeyBackupDialog_recoveryKey"},i.a.createElement("code",{ref:this.recoveryKeyNode},this.keyBackupInfo.recovery_key)),i.a.createElement("div",{className:"mx_CreateKeyBackupDialog_recoveryKeyButtons"},i.a.createElement("button",{className:"mx_Dialog_primary",onClick:this.onCopyClick},Object(u.b)("Copy")),i.a.createElement("button",{className:"mx_Dialog_primary",onClick:this.onDownloadClick},Object(u.b)("Download"))))))}renderPhaseKeepItSafe(){let e;return this.state.copied?e=Object(u.b)("Your Security Key has been <b>copied to your clipboard</b>, paste it to:",{},{b:e=>i.a.createElement("b",null,e)}):this.state.downloaded&&(e=Object(u.b)("Your Security Key is in your <b>Downloads</b> folder.",{},{b:e=>i.a.createElement("b",null,e)})),i.a.createElement("div",null,e,i.a.createElement("ul",null,i.a.createElement("li",null,Object(u.b)("<b>Print it</b> and store it somewhere safe",{},{b:e=>i.a.createElement("b",null,e)})),i.a.createElement("li",null,Object(u.b)("<b>Save it</b> on a USB key or backup drive",{},{b:e=>i.a.createElement("b",null,e)})),i.a.createElement("li",null,Object(u.b)("<b>Copy it</b> to your personal cloud storage",{},{b:e=>i.a.createElement("b",null,e)}))),i.a.createElement(P.a,{primaryButton:Object(u.b)("Continue"),onPrimaryButtonClick:this.createBackup,hasCancel:!1},i.a.createElement("button",{onClick:this.onKeepItSafeBackClick},Object(u.b)("Back"))))}renderBusyPhase(){return i.a.createElement("div",null,i.a.createElement(d.a,null))}renderPhaseDone(){return i.a.createElement("div",null,i.a.createElement("p",null,Object(u.b)("Your keys are being backed up (the first backup could take a few minutes).")),i.a.createElement(P.a,{primaryButton:Object(u.b)("OK"),onPrimaryButtonClick:this.onDone,hasCancel:!1}))}renderPhaseOptOutConfirm(){return i.a.createElement("div",null,Object(u.b)("Without setting up Secure Message Recovery, you won't be able to restore your encrypted message history if you log out or use another session."),i.a.createElement(P.a,{primaryButton:Object(u.b)("Set up Secure Message Recovery"),onPrimaryButtonClick:this.onSetUpClick,hasCancel:!1},i.a.createElement("button",{onClick:this.onCancel},"I understand, continue without")))}titleForPhase(e){switch(e){case C.Passphrase:return Object(u.b)("Secure your backup with a Security Phrase");case C.PassphraseConfirm:return Object(u.b)("Confirm your Security Phrase");case C.OptOutConfirm:return Object(u.b)("Warning!");case C.ShowKey:case C.KeepItSafe:return Object(u.b)("Make a copy of your Security Key");case C.BackingUp:return Object(u.b)("Starting backup…");case C.Done:return Object(u.b)("Success!");default:return Object(u.b)("Create key backup")}}render(){let e;if(this.state.error)e=i.a.createElement("div",null,i.a.createElement("p",null,Object(u.b)("Unable to create key backup")),i.a.createElement(P.a,{primaryButton:Object(u.b)("Retry"),onPrimaryButtonClick:this.createBackup,hasCancel:!0,onCancel:this.onCancel}));else switch(this.state.phase){case C.Passphrase:e=this.renderPhasePassPhrase();break;case C.PassphraseConfirm:e=this.renderPhasePassPhraseConfirm();break;case C.ShowKey:e=this.renderPhaseShowKey();break;case C.KeepItSafe:e=this.renderPhaseKeepItSafe();break;case C.BackingUp:e=this.renderBusyPhase();break;case C.Done:e=this.renderPhaseDone();break;case C.OptOutConfirm:e=this.renderPhaseOptOutConfirm()}return i.a.createElement(k.a,{className:"mx_CreateKeyBackupDialog",onFinished:this.props.onFinished,title:this.titleForPhase(this.state.phase),hasCancel:[C.Passphrase,C.Done].includes(this.state.phase)},i.a.createElement("div",null,e))}}}}]);
//# sourceMappingURL=8.js.map